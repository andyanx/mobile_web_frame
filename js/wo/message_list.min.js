define("wo/message_list",["base_package","frame_package","btn_package","wo_config","commom_function","get_template","new_alert_v2","emoticon_module","notice"],function(e,i){var a,n=e("zepto"),t=e("wo_config"),d=e("page_control"),o=e("backbone"),s=e("commom_function"),l=e("mustache"),r=e("new_alert_v2"),c=e("ua"),_=e("emoticon_module"),m=e("notice"),p=1,f=!1;i.route={"message_list/:query":"message_list"},i.new_page_entity=function(){function i(){return q.models[0]&&0==q.models[0].attributes.relation_id?(r.show({text:"\u4f5c\u54c1\u4e0d\u5b58\u5728\u6216\u5df2\u88ab\u539f\u4f5c\u8005\u5220\u9664",type:"info",is_fade:!1,is_cover:!0,auto_close_time:2e3,closed_callback:function(){d.back()}}),!1):(E.clear_list(),q.each(function(e){if(e.attributes.send_user_id==C){var i=new z({model:e});E.add_list_item(i)}else{var i=new $({model:e});E.add_list_item(i)}}),h(!1),O.scroll_to(0),void 0)}function v(e){var i=new z({model:e});E.add_list_item(i)}function g(e){var i=e.to_user_id,a=e.content,n=e.success||function(){},d=e.error||function(){};s.send_request({url:t.ajax_url.add_message,data:{send_user_id:C,to_user_id:i,content:a},callback:function(e){"function"==typeof n&&n.call(this,e)},error:function(){"function"==typeof d&&d.call(this)}})}function h(e){var i=N.find(".select-emotion em");e?(V.show(),N.find(".message-list-comment").hide(),i.removeClass("icon").addClass("active_icon")):(V.hide(),N.find(".message-list-comment").show(),i.removeClass("active_icon").addClass("icon"))}var u={route:{"message_list/:query":"message_list"},transition_type:"slideup",dom_not_cache:!0,ignore_exist:!0},b=o.Model.extend({defaults:{}}),w=20,y={ajax_load_finish:function(e,i){N.find("[data-message_person]").html(i.nickname),E.more_btn_reset(),null!=i&&((0==i.list||w>i.list.length)&&E.hide_more_btn(),i.list&&0==i.list.length?N.find(".tigs-letter").show():N.find(".tigs-letter").hide())},before_refresh:function(){},before_get_more:function(){E.more_btn_loading()}},x=o.Collection.extend({model:b,refresh:function(e){y.data={to_user_id:a},e!==void 0&&(y.data.is_real_data=1),s.collection_refresh_function.call(this,y)},get_more_item:function(){y.data={to_user_id:a},s.collection_get_more_function.call(this,y)},url:t.ajax_url.get_message_list,parse:function(e){return e.result_data.is_pull_back?(N.find("[data-pull_back_btn] .filter_text").html("\u6062\u590d"),N.find("[data-pull_back_btn]").attr("can_pull_back",0)):(N.find("[data-pull_back_btn] .filter_text").html("\u62c9\u9ed1"),N.find("[data-pull_back_btn]").attr("can_pull_back",1)),e&&e.result_data.list!==void 0?e.result_data.list:e}}),k=0,$=o.View.extend({tagName:"tr",className:"reply-letter",initialize:function(){var e=this.model.toJSON(),i='<td width="35" valign="top" class="message-list-td"><div class="re"><div class="reply-person-pic-wrap" data_to_person></div><div class="person-pic middle-center"><img src="{{user_icon}}" class="max-width-height"></div></div></td><td class="message-list-td"><div class="letter-content dib re radius-2px"><em class="icon"></em><div class="lh16 f12">{{{content}}}</div><p class="time f10 mt5 color999">{{add_time}}</p></div></td><td width="35">&nbsp;</td>';this.send_user_id=e.send_user_id,this.user_name=e.user_name;var a=l.to_html(i,e);n(this.el).html(a)},events:{"tap [data-user_profile_anchor]":function(){d.navigate_to_page("user_profile/"+this.user_id)},"tap [data_to_person]":function(){d.navigate_to_page("user_profile/"+this.send_user_id)}}}),z=o.View.extend({tagName:"tr",className:"send-letter",initialize:function(){var e=this.model.toJSON(),i='<td width="35" >&nbsp;</td><td align="right" class="message-list-td"><div class="letter-content dib re radius-2px"><em class="icon"></em><div class="lh16 f12">{{{content}}}</div><p class="time f10 mt5 color999">{{add_time}}</p></div></td><td width="35" align="right" valign="top" class="message-list-td"><div class="re"><div class="send-person-pic-wrap" data_to_person></div><div class="person-pic middle-center"><img src="{{user_icon}}" class="max-width-height"></div></div></td>';this.send_user_id=e.send_user_id;var a=l.to_html(i,e);n(this.el).html(a)},events:{"tap [data_to_person]":function(){d.navigate_to_page("user_profile/"+this.send_user_id)}}}),j=o.View.extend({initialize:function(){var i=this,a=e("load_more_btn")();a.$el.css({height:"auto"}),a.$el.removeClass("pb15"),n(this.el).parent().append(a.$el),i.load_more_btn=a,this.load_more_btn.hide()},add_list_item:function(e){n(this.el).append(e.$el),this.load_more_btn.show()},clear_list:function(){n(this.el).html(""),this.load_more_btn.hide()},hide_more_btn:function(){this.load_more_btn.hide()},more_btn_loading:function(){this.load_more_btn.loadding()},more_btn_reset:function(){this.load_more_btn.reset()},show_more_btn:function(){this.load_more_btn.reset()}});u.initialize=function(){this.render()},u.render=function(){var i=e("get_template"),a=i.template_obj(),t=a.message_list;this.$el.append(n(t))};var C,I=!1;u.events={swiperight:function(){s.get_ua().is_uc||d.back()},"tap .ui-btn-prev-wrap":function(){d.back()},"tap .data-more_btn":function(){return d.page_transit_status()?!1:(q.get_more_item(),void 0)},"tap .send-btn":function(e){if(d.page_transit_status())return!1;if(0!=p){if(0==C)return d.navigate_to_page("login"),void 0;if(!I){I=!0;var i=N.find("textarea"),t=n(e.currentTarget);if(""==i.val())return r.show({text:"\u79c1\u4fe1\u5185\u5bb9\u4e3a\u7a7a",type:"info",auto_close_time:2e3}),I=!1,void 0;t.text("\u53d1\u9001\u4e2d..."),g({to_user_id:a,content:i.val(),success:function(e){1==e.result?(q.refresh(!0),O.scroll_to(0),i.val(""),window.refresh_message=!0):-2==e.result?r.show({text:"\u62b1\u6b49\uff01\u4e24\u4e2a\u7528\u6237\u975e\u4e92\u76f8\u5173\u6ce8\uff0c\u4e0d\u80fd\u79c1\u4fe1",type:"info",auto_close_time:2e3}):3==e.result?r.show({text:e.err_msg,type:"info",auto_close_time:2e3}):r.show({text:e.err_msg,type:"info",auto_close_time:2e3}),k=0,t.text("\u53d1\u9001"),100100==a?i.attr("placeholder","\u8f93\u5165\u4f60\u5b9d\u8d35\u7684\u610f\u89c1"):i.attr("placeholder","\u5199\u79c1\u4fe1..."),i.blur(),I=!1},error:function(){I=!1,t.text("\u53d1\u9001")}})}}},"tap .select-emotion":function(){if(0!=p){var e=N.find(".select-emotion em"),i=e.hasClass("active_icon");i?h(!1):h(!0),c.isIDevice&&N.find("textarea").blur()}},"tap .gift-emotion":function(){d.navigate_to_page("send_gift/"+a,T)},"tap [data-pull_back_btn]":function(e){var i=n(e.currentTarget);parseInt(i.attr("can_pull_back"));var o,l;if(1==i.attr("can_pull_back")?(o="\u786e\u5b9a\u62c9\u9ed1\u8be5\u597d\u53cb\uff1f",l=1):(o="\u786e\u5b9a\u6062\u590d\u8be5\u9ed1\u540d\u5355\u597d\u53cb\uff1f",l=0),confirm(o)){if(f)return;f=!0,s.send_request({url:t.ajax_url.pull_back,data:{to_user_id:a,pull_back_tag:l},callback:function(e){if(f=!1,1==e.code){var a="";e.tag?(a="\u62c9\u9ed1",i.attr("can_pull_back",1)):(a="\u6062\u590d",i.attr("can_pull_back",0),d.back()),window.refresh_message=!0,i.find(".filter_text").html(a)}else r.show({text:e.txt,type:"info",auto_close_time:1e3})},error:function(){f=!1}})}}};var T=!1;u.window_change=function(e){var i=window.innerHeight-N.find(".top_set").height()-45-10,a=n(e.el).find(".message-list-comment");a.css("height",i)},u.page_back_show=function(){q.refresh()},u.page_show=function(e,i){n(e.el).find("[data-reply_btn]").attr("selected_cmt",0),S=i,0!=p&&n(e.el).find("textarea").removeAttr("readonly")};var O,q,N,S,E,P,V,C;u.page_init=function(t,o,l){if(C=s.get_local_poco_id(),0>=C)return r.show({text:"\u5c1a\u672a\u767b\u5f55",type:"info",is_fade:!1,is_cover:!0,auto_close_time:1e3,closed_callback:function(){d.back()}}),!1;N=n(t.el),S=o,P=l,a=o[0];var c=e("scroll"),p=n(t.el).find(".message-list-comment"),f=window.innerHeight-N.find(".top_set").height()-45-10;O=c.new_scroll(p,{view_height:f}),V=new _({click_icon_callback:function(e){var i=N.find("textarea"),a=i.val();a+=e,i.val(a)}}),N.find(".top_set").after(V.$el);var g=n(t.el).find("header"),h=e("page_back_btn")();g.prepend(h.$el),E=new j({el:n(t.el).find(".person-letter-send-item table")}),q=new x,q.bind("reset",i,t),q.bind("add",v,t),q.refresh(),m.update_unread_status_by_type("message"),m.footer_notice_ui_refresh(),P&&"from_message"==P.state_tag&&(m.update_unread_status_by_type("message",P.unread_count),P.unread_count=0),100100==a&&(N.find("textarea").attr("placeholder","\u8f93\u5165\u4f60\u5b9d\u8d35\u7684\u610f\u89c1"),N.find(".gift-emotion").hide(),N.find("[data-pull_back_btn]").hide())};var W=e("page").new_page(u);return W}}),"function"==typeof process_add&&process_add();