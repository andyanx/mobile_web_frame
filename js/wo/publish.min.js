define("wo/publish",["base_package","frame_package","btn_package","commom_function","wo_config","get_template","footer_view","new_alert_v2","img_process","emoticon_module","topic_txt_module","app_function"],function(e,i){var a=e("zepto");e("jquery");var t=e("cookies"),n=e("wo_config"),d=e("page_control");e("backbone");var o=e("commom_function"),s=e("app_function"),n=e("wo_config"),l=e("ua"),r=e("emoticon_module"),c=e("topic_txt_module"),_=e("img_process");i.route={publish:"publish"},i.new_page_entity=function(){function i(e){var i="http://imgup-s.poco.cn/ultra_upload_service/get_img_file_fun_qing.php?acao_h=1&t="+Math.random();a.ajax({url:i,type:"POST",data:{return_json:1,acao_h:1,get_img_type:3,img_base64:e,user_id:o.get_local_poco_id()},dataType:"json",timeout:n.upload_timeout,xhr:function(){var e=a.ajaxSettings.xhr();return e.upload.addEventListener("progress",function(e){var i=parseInt(100*(e.loaded/e.total));$.find(".upload_percent").html(i+"%")},!1),e},success:function(e){x=!0,$.find(".upload_tips").hide();var i=o.matching_img_size(e.item_url,"mm");$.find(".publish_img_output").attr("src",i).show(),$.find(".upload-img").css({"background-color":"#fff"})},error:function(){$.find(".upload_tips").hide(),u.show({text:"\u4e0a\u4f20\u56fe\u7247\u5931\u8d25",type:"info",append_target:$,auto_close_time:2e3})}})}function m(e){var i=$.find(".select-emotion em");e?(j.show(),i.addClass("active_icon")):(j.hide(),i.removeClass("active_icon"))}function p(e){var i=$.find(".select-topic-icon");e?(C.show(),i.addClass("active")):(C.hide(),i.removeClass("active"))}function f(e,i,a){w.push(e),b.push(i),at_name_str=a;var t=$.find("[data-publish_text]").val();t+=a,$.find("[data-publish_text]").val(t),console.log($.find("[data-publish_text]").val())}var h,g,v=!1,u=e("new_alert_v2"),b=[],w=[],y={route:{publish:"publish"},transition_type:"slideup",dom_not_cache:!0};y.initialize=function(){this.render()},y.render=function(){var i=e("get_template"),t=i.template_obj(),n=t.publish;this.$el.append(a(n))},y.events={"tap .ui-btn-prev-wrap":function(){d.back(!0)},"tap .no_login":function(){return d.page_transit_status()?!1:(d.navigate_to_page("login"),void 0)},"change .publish_img_file":function(e){var a=e.currentTarget,t=a.files[0];$.find(".upload_tips").show(),$.find(".upload-img").css({"background-image":"none","background-color":"#eef0ee"}),_.start_img_process(t,{type:t.type},function(e){i(e)})},"click [data-nav_to_publish]":function(){_.can_web_upload_img()&&($.find(".publish-nophoto").show(),$.find(".decoration").hide())},"click .btn-send":function(i){if(!x)return u.show({text:"\u8bf7\u5148\u9009\u62e9\u8981\u4e0a\u4f20\u7684\u7167\u7247",type:"info",append_target:$,auto_close_time:2e3}),void 0;if(!v&&!h){v=!0;var t=this,s=t.$el.find(".publish_img_output").attr("src"),l=t.$el.find("[data-publish_text]").val(),r=a(i.currentTarget);r.find("span").text("\u53d1\u9001\u4e2d...");var c=e("new_alert_v2");o.send_request({url:n.ajax_url.publish,data:{img_url:s,nick_name_arr:b,user_id_arr:w,text:l,xcoordinate:I,ycoordinate:T},callback:function(e){if(1==e.result){h=!0;var i="http://"+location.host+location.pathname+"?"+parseInt((new Date).getTime());u.show({text:"\u53d1\u5e03\u6210\u529f",is_cover:!0,auto_close_time:2e3,append_target:$,closed_callback:function(){return v=!1,k&&"theme_special"==k.link_type?(location.href=i+"#user_profile/"+z,void 0):(b=[],w=[],k&&k.page_from_url?location.href=k.page_from_url:d.back(),void 0)}})}else c.close(!0),u.show({text:"\u53d1\u5e03\u5931\u8d25",auto_close_time:2e3,append_target:$,closed_callback:function(){v=!1}});r.find("span").text("\u53d1\u9001")},error:function(){c.close(!0),v=!1,r.find("span").text("\u53d1\u9001")}})}},"tap .upload-img":function(){s.app_get_picture({width:990},function(e){if("0000"==e.code){$.find(".upload_tips").show(),$.find(".upload-img").css({"background-image":"none","background-color":"#eef0ee"});var a="data:image/jpeg;base64,"+e.image;i(a)}})},"tap [camera_action_shot]":function(){if(k&&k.camera_sharestr)var e=encodeURIComponent(k.camera_sharestr);else var e="";window.location.href="PocoCamera://action_shot/?sharestr="+e},"tap [camera_action_album]":function(){if(k&&k.camera_sharestr)var e=encodeURIComponent(k.camera_sharestr);else var e="";window.location.href="PocoCamera://action_album/?sharestr="+e},"tap .select-emotion":function(){var e=$.find(".select-emotion em"),i=e.hasClass("active_icon");i?m(!1):(m(!0),C&&p(!1)),l.isIDevice&&$.find("textarea").blur()},"tap .select-topic":function(){var e=$.find(".select-topic-icon"),i=e.hasClass("active"),e=$.find(".select-topic-icon");e.addClass("active"),C?i?p(!1):(p(!0),j&&m(!1)):(g=u.show({text:"\u6b63\u5728\u52a0\u8f7d\u8bdd\u9898",type:"loading",is_cover:!1,append_target:$}),o.send_request({url:n.ajax_url.get_topic_txt_list,data:{t:parseInt((new Date).getTime())},callback:function(e){C=new c({data:e.result_data,history_data:window.localStorage.getItem("record_topic_arr"),click_topic_txt_callback:function(e){var i=$.find("[data-publish_text]"),a=i.val();a+=e,i.val(a)},click_more_callback:function(){var e=$.find("[data-publish_text]");d.navigate_to_page("publish_more_topic",{textarea:e})}}),$.find("[data-topic_txt_wrapper]").html(C.$el),i?p(!1):(p(!0),j&&m(!1)),g.close()},error:function(){C=null,g.close()}}))},"tap .at-emotion":function(){d.navigate_to_page("get_friends_list/from_at",{textarea:$.find("[data-publish_text]"),at_params:f})}},y.window_change=function(e){a(e.el).find(".main_wraper").height(o.container_height_with_head())};var x,k,$,z,j,C,I=0,T=0;y.page_before_show=function(){C&&C.refresh(JSON.parse(window.localStorage.getItem("record_topic_arr")))},y.page_init=function(i,n,c){k=c||{},$=a(i.el);var m=a(i.el).find("header"),p=e("page_back_btn")();m.prepend(p.$el);var f=o.get_local_poco_id(),h=t.readCookie("cok_framename");if(null!=h&&""!=h)$.find(".frame_publish").show(),$.find(".publish-nophoto").hide(),$.find(".decoration").hide(),k.key_word,o.bind_poco_in_camera(!0);else{if(0>=f)return u.show({text:"\u5c1a\u672a\u767b\u5f55",type:"info",is_fade:!1,is_cover:!0,auto_close_time:1e3,closed_callback:function(){d.back()}}),!1;if(s.get_app_coordinate(function(e){"0000"==e.code&&(I=e.longitude,T=e.latitude)}),x=!1,k&&null!=k.key_word&&$.find("[data-publish_text]").val("#"+k.key_word+"#"),s.is_world_app())a(i.el).find(".publish_form").hide(),a(i.el).find(".publish-nophoto").show(),a(i.el).find(".decoration").hide();else{if(!_.can_web_upload_img())return a(i.el).find(".no_support_upload").show(),a(i.el).find("[data-nav_to_publish]").removeClass("footer_btn_style").addClass("cancel_btn"),!1;a(i.el).find(".publish-nophoto").show(),a(i.el).find(".decoration").hide(),l.isAndroid&&l.is_uc?($.find("[data-for_no_android_uc_file]").hide(),$.find("[data-for_android_uc_file]").show()):($.find("[data-for_no_android_uc_file]").show(),$.find("[data-for_android_uc_file]").hide())}}j=new r({emotion_wraper_height:window.innerHeight-120-52-55,click_icon_callback:function(e){var i=$.find("[data-publish_text]"),a=i.val();a+=e,i.val(a)}}),$.find(".comment-page").after(j.$el)};var q=e("page").new_page(y);return q}}),"function"==typeof process_add&&process_add();