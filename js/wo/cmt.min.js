define("wo/cmt",["base_package","frame_package","btn_package","wo_config","commom_function","get_template","new_alert_v2","emoticon_module"],function(e,t){var a=e("zepto"),i=e("wo_config"),n=e("page_control"),o=e("backbone"),s=e("commom_function"),l=e("mustache"),r=e("new_alert_v2"),c=e("ua"),_=1,d="",p="",h=e("emoticon_module");t.route={"cmt/:query(/:from_world_daliy)":"cmt"},t.new_page_entity=function(){function t(){return T.models[0]&&0==T.models[0].attributes.art_id?(r.show({text:"\u4f5c\u54c1\u4e0d\u5b58\u5728\u6216\u5df2\u88ab\u539f\u4f5c\u8005\u5220\u9664",type:"info",is_fade:!1,is_cover:!0,auto_close_time:2e3,closed_callback:function(){n.back()}}),!1):(D.clear_list(),T.each(function(e){var t=new $({model:e});D.add_list_item(t)}),u(!1),N.scroll_to(0),void 0)}function f(e){var t=new $({model:e});D.add_list_item(t)}function m(e){var t=e.art_id,a=e.cmt_id,n=e.content,o=e.user_id_arr,l=e.nick_name_arr,r=e.success||function(){},c=e.error||function(){};s.send_request({url:i.ajax_url.add_cmt,data:{art_id:t,cmt_id:a,user_id_arr:o,nick_name_arr:l,content:n,from_world_daliy:Z,t:parseInt((new Date).getTime())},callback:function(e){"function"==typeof r&&r.call(this,e)},error:function(){"function"==typeof c&&c.call(this)}})}function u(e){var t=O.find(".select-emotion em");e?(O.find(".icon-emotion-32-bg").show(),O.find(".list-comment").hide(),t.removeClass("icon").addClass("active_icon")):(O.find(".icon-emotion-32-bg").hide(),O.find(".list-comment").show(),t.removeClass("active_icon").addClass("icon"))}function v(e,t,a){J.push(e),S.push(t),M=a;var i=O.find("textarea").val();i+=a,O.find("textarea").val(i),console.log(O.find("textarea").val())}function u(e){var t=O.find(".select-emotion em");e?(P.show(),O.find(".list-comment").hide(),t.removeClass("icon").addClass("active_icon")):(P.hide(),O.find(".list-comment").show(),t.removeClass("active_icon").addClass("icon"))}var g={route:{"cmt/:query(/:from_world_daliy)":"cmt"},transition_type:"slideup",dom_not_cache:!0,ignore_exist:!0},b=o.Model.extend({defaults:{cmt_id:"",content:"",cover_img_url:"",reply_user_id:"",reply_user_name:"",user_id:"",user_name:"",user_icon:"",add_time:""}}),w=20,y={ajax_load_finish:function(e,t){D.more_btn_reset(),W.reset(),null!=t&&((0==t.cmt_list||w>t.cmt_list.length)&&D.hide_more_btn(),_=t.can_cmt,0==t.can_cmt?(O.find("textarea").attr({placeholder:d}),O.find(".send-btn").addClass("disable")):1==t.can_cmt&&O.find(".send-btn").removeClass("disable"))},before_refresh:function(){W.loadding()},before_get_more:function(){D.more_btn_loading()}},x=o.Collection.extend({model:b,refresh:function(e){var t=V[0];y.data={art_id:t,from_world_daliy:Z},e!==void 0&&(y.data.is_real_data=1),s.collection_refresh_function.call(this,y)},get_more_item:function(){var e=V[0];y.data={art_id:e,from_world_daliy:Z},s.collection_get_more_function.call(this,y)},url:function(){return i.ajax_url.cmt},parse:function(e){return e&&e.cmt_list!==void 0?e.cmt_list:e}}),k=0,$=o.View.extend({tagName:"div",className:"border-btm",initialize:function(){var e=this.model.toJSON();this.reply_user_id=e.reply_user_id,this.user_id=e.user_id,this.cmt_id=e.cmt_id,this.user_name=e.user_name,this.cmt_can_delete=e.cmt_can_delete,this.user_sex=e.user_sex;var t="";"\u7537"==this.user_sex?t="icon-male":"\u5973"==this.user_sex&&(t="icon-female");var i='<table border="0" cellspacing="0" cellpadding="0"><tr><td width="35" data-user_profile_anchor ><div class="user-img middle-center" ><img src="{{user_icon}}" class="max-width-height" /></div></td> <td> <div class="user-info" data-reply_btn data-cmt_id={{cmt_id}} style="position: relative;"><div style="text-align:center;width: 40px;position: absolute;right: 0;bottom: 0;height: 23px;display:none" data-del_btn><span class="ui-icon-delete radius-2px"><em class="icon-delete icon-bg-common"></em></span></div> <div class="clearfix" style="line-height:12px"><span class="name lh16 fl">{{user_name}}</span><em style="margin-top:0" class="sex_icon icon-bg-common '+t+'"></em></div><p class="txt lh20 mt5 mb5">{{#reply_user_name}} \u56de\u590d <span class="name">{{reply_user_name}}</span>\uff1a{{/reply_user_name}}{{{content}}}</p><div class="clearfix mt5"> <time class="time font-arial fl">{{add_time}}</time> <span class="icon icon-bg-common fr"></span> </div> </div>     </td> </tr> </table>',n=l.to_html(i,e);a(this.el).html(n)},events:{"tap [data-user_profile_anchor]":function(){n.navigate_to_page("user_profile/"+this.user_id)},"tap poco_at":function(e){var t=a(e.currentTarget);n.navigate_to_page("user_profile/"+t.attr("user_id"))},"tap [data-reply_btn]":function(){if(n.page_transit_status())return!1;if(0!=_&&!I){var e=O.find("textarea");a(event.currentTarget).find(".name").html(),e.val(""),e.attr("placeholder","\u56de\u590d :"+this.user_name),k=this.cmt_id}},hold:function(e){1==this.cmt_can_delete&&(console.log("delete"),O.find("[data-del_btn]").hide(),a(e.currentTarget).find("[data-del_btn]").show())},"tap [data-del_btn]":function(){var e=V[0],t=this.cmt_id,a=this.reply_user_id,n=this.user_id,o=r.show({text:"\u5220\u9664\u4e2d",type:"loading",is_cover:!0,append_target:O});s.send_request({url:i.ajax_url.del_cmt,data:{reply_user_id:a,user_id:n,art_id:e,cmt_id:t,from_world_daliy:Z,t:parseInt((new Date).getTime())},callback:function(e){o.close(),1==e.ret_code?r.show({text:"\u5df2\u5220\u9664\u7559\u8a00",type:"success",is_cover:!0,auto_close_time:1e3,closed_callback:function(){O.find("textarea").attr("placeholder","\u5199\u8bc4\u8bba..."),T.refresh()}}):r.show({text:"\u5220\u9664\u5931\u8d25",type:"info",auto_close_time:1e3})}})}}}),j=o.View.extend({initialize:function(){var t=this,i=e("load_more_btn")();i.$el.css({height:"auto"}),i.$el.removeClass("pb15"),a(this.el).parent().append(i.$el),t.load_more_btn=i,this.load_more_btn.hide()},add_list_item:function(e){a(this.el).append(e.$el),this.load_more_btn.show()},clear_list:function(){a(this.el).html(""),this.load_more_btn.hide()},hide_more_btn:function(){this.load_more_btn.hide()},more_btn_loading:function(){this.load_more_btn.loadding()},more_btn_reset:function(){this.load_more_btn.reset()},show_more_btn:function(){this.load_more_btn.reset()}});g.initialize=function(){this.render()},g.render=function(){var t=e("get_template"),i=t.template_obj(),n=i.cmt_list;this.$el.append(a(n))};var C,z=!1,I=!1;g.events={"tap .ui-btn-prev-wrap":function(){n.back()},swiperight:function(){s.get_ua().is_uc||n.back()},"tap .at-emotion":function(){V[0],n.navigate_to_page("get_friends_list/from_at",{textarea:O.find("textarea"),at_params:v})},"tap .ui-btn-refresh-wrap":function(){return n.page_transit_status()?!1:(T.refresh(),void 0)},"tap .data-more_btn":function(){return n.page_transit_status()?!1:(T.get_more_item(),void 0)},"tap .send-btn":function(e){if(n.page_transit_status())return!1;if(0!=_){if(C=s.get_local_poco_id(),0==C)return n.navigate_to_page("login"),void 0;if(!z){z=!0;var t=V[0],i=O.find("textarea"),o=a(e.currentTarget);if(""==i.val())return r.show({text:"\u7559\u8a00\u5931\u8d25\uff0c\u7559\u8a00\u4e3a\u7a7a",type:"info",auto_close_time:2e4}),z=!1,void 0;o.text("\u53d1\u9001\u4e2d..."),m({art_id:t,cmt_id:k,content:i.val(),user_id_arr:J,nick_name_arr:S,success:function(e){e.result>0?(T.refresh(!0),N.scroll_to(0),i.val(""),J=[],S=[]):-1==e.result?r.show({text:"\u7559\u8a00\u5931\u8d25",type:"info",auto_close_time:2e3}):-2==e.result?r.show({text:"\u62b1\u6b49\uff01\u4e0d\u80fd\u91cd\u590d\u7559\u8a00",type:"info",auto_close_time:2e3}):-3==e.result?r.show({text:"\u62b1\u6b49\uff01\u60a8\u8fd8\u6ca1\u6709\u53d1\u5e03\u8fc7\u4f5c\u54c1\uff0c\u4e0d\u80fd\u7559\u8a00",type:"info",auto_close_time:2e3}):r.show({text:"\u7559\u8a00\u5931\u8d25",type:"info",auto_close_time:2e3}),k=0,o.text("\u53d1\u9001"),i.attr("placeholder","\u5199\u8bc4\u8bba..."),i.blur(),z=!1},error:function(){z=!1,o.text("\u53d1\u9001")}})}}},"tap .select-emotion":function(){if(0!=_){var e=O.find(".select-emotion em"),t=e.hasClass("active_icon");t?u(!1):u(!0),c.isIDevice&&O.find("textarea").blur()}}},g.window_change=function(e){var t=window.innerHeight-O.find(".top_set").height()-45-10,i=a(e.el).find(".list-comment");i.css("height",t)},g.page_show=function(e,t){a(e.el).find("[data-reply_btn]").attr("selected_cmt",0),V=t,0!=_&&a(e.el).find("textarea").removeAttr("readonly")};var N,T,O,V,D,q,W,P,Z,S=[],J=[],M="";g.page_init=function(i,n,o){O=a(i.el),V=n,q=o,Z=n[1]&&"from_world_daliy"==""+n[1]?1:0,W=e("refresh_btn")(),i.$el.find(".header").append(W.$el),d=O.find("textarea").attr("data-can_cmt_des"),p=O.find("textarea").attr("place_holder");var s=e("scroll"),l=a(i.el).find(".list-comment"),r=window.innerHeight-O.find(".top_set").height()-45-10;N=s.new_scroll(l,{view_height:r}),P=new h({click_icon_callback:function(e){var t=O.find("textarea"),a=t.val();a+=e,t.val(a)}}),O.find(".top_set").after(P.$el);var c=a(i.el).find("header"),m=e("page_back_btn")();if(c.prepend(m.$el),D=new j({el:a(i.el).find(".list-comment-container")}),T=new x,T.bind("reset",t,i),T.bind("add",f,i),T.refresh(),0!=_&&q!==void 0){var u=q.nickname?"\u56de\u590d :"+q.nickname:"\u5199\u8bc4\u8bba...";k=q.cmt_id,O.find("textarea").attr("placeholder",u)}};var R=e("page").new_page(g);return R}}),"function"==typeof process_add&&process_add();